---
# Main playbook to set up Nomad infrastructure with CIFS/SMB CSI plugin
#
# Usage:
#   Deploy with Plex (default):
#     ansible-playbook -i inventory.ini site.yml
#
#   Deploy with Jellyfin:
#     ansible-playbook -i inventory.ini site.yml -e media_server=jellyfin
#
#   Deploy without GPU transcoding:
#     ansible-playbook -i inventory.ini site.yml -e media_server_gpu_transcoding=false
#
# This playbook sets up:
#   - Consul for service discovery
#   - Nomad cluster with Podman driver
#   - CIFS/SMB CSI plugin for network storage
#   - CSI volumes for media and backup storage
#   - Media server (Plex or Jellyfin) via Nomad Pack

- name: Validate configuration
  hosts: controller
  gather_facts: false
  tasks:
    - name: Validate media_server value
      ansible.builtin.assert:
        that:
          - media_server in ['plex', 'jellyfin']
        fail_msg: "media_server must be 'plex' or 'jellyfin'. Got: {{ media_server }}"
        success_msg: "Will deploy media server: {{ media_server }}"

- name: Disable Firewall
  ansible.builtin.import_playbook: playbooks/disable-firewall.yml

- name: Install Consul
  ansible.builtin.import_playbook: playbooks/install-consul.yml

- name: Configure Consul
  ansible.builtin.import_playbook: playbooks/configure-consul.yml

- name: Install Nomad
  ansible.builtin.import_playbook: playbooks/install-nomad.yml

- name: Configure Nomad
  ansible.builtin.import_playbook: playbooks/configure-nomad.yml

- name: Install Podman Driver
  ansible.builtin.import_playbook: playbooks/install-podman-driver.yml

- name: Setup Media Server Users
  ansible.builtin.import_playbook: playbooks/setup-users.yml

- name: Deploy CSI Plugins
  ansible.builtin.import_playbook: playbooks/deploy-csi-plugins.yml

- name: Deploy CSI Volumes
  ansible.builtin.import_playbook: playbooks/deploy-csi-volumes.yml

- name: Deploy Media Server
  ansible.builtin.import_playbook: playbooks/deploy-media-server.yml
