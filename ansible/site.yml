---
# Main playbook to set up complete Nomad media server infrastructure
#
# Usage:
#   Deploy Plex (default): ansible-playbook -i inventory.ini site.yml
#   Deploy Jellyfin:       ansible-playbook -i inventory.ini site.yml -e media_server=jellyfin
#   Deploy both:           ansible-playbook -i inventory.ini site.yml -e media_server=both
#
# Optional flags (default: true):
#   -e enable_updates=false  Skip deploying update jobs
#   -e enable_backups=false  Skip deploying backup jobs

- name: Validate configuration
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Validate media_server value
      ansible.builtin.assert:
        that:
          - media_server in ['plex', 'jellyfin', 'both']
        fail_msg: "media_server must be 'plex', 'jellyfin', or 'both'. Got: {{ media_server }}"
        success_msg: "Deploying media server(s): {{ media_server }}"

- name: Disable Firewall
  ansible.builtin.import_playbook: playbooks/disable-firewall.yml

- name: Install Consul
  ansible.builtin.import_playbook: playbooks/install-consul.yml

- name: Configure Consul
  ansible.builtin.import_playbook: playbooks/configure-consul.yml

- name: Install Nomad
  ansible.builtin.import_playbook: playbooks/install-nomad.yml

- name: Configure Nomad
  ansible.builtin.import_playbook: playbooks/configure-nomad.yml

- name: Install Podman Driver
  ansible.builtin.import_playbook: playbooks/install-podman-driver.yml

- name: Setup Host Volume Directories
  ansible.builtin.import_playbook: playbooks/setup-directories.yml

- name: Deploy CSI Volumes
  ansible.builtin.import_playbook: playbooks/deploy-csi-volumes.yml

- name: Deploy Media Server Jobs
  ansible.builtin.import_playbook: playbooks/deploy-media-jobs.yml
