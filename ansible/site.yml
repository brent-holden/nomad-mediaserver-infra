---
# Main playbook to set up Nomad infrastructure with CIFS/SMB CSI plugin
#
# Usage:
#   ansible-playbook -i inventory.ini site.yml
#
# This playbook sets up:
#   - Consul for service discovery
#   - Nomad cluster with Podman driver
#   - CIFS/SMB CSI plugin for network storage
#   - CSI volumes for media and backup storage
#
# After running this playbook, deploy media servers using nomad-pack:
#   nomad-pack registry add media github.com/brent-holden/nomad-media-packs
#   nomad-pack run plex --registry=media
#   nomad-pack run jellyfin --registry=media

- name: Disable Firewall
  ansible.builtin.import_playbook: playbooks/disable-firewall.yml

- name: Install Consul
  ansible.builtin.import_playbook: playbooks/install-consul.yml

- name: Configure Consul
  ansible.builtin.import_playbook: playbooks/configure-consul.yml

- name: Install Nomad
  ansible.builtin.import_playbook: playbooks/install-nomad.yml

- name: Configure Nomad
  ansible.builtin.import_playbook: playbooks/configure-nomad.yml

- name: Install Podman Driver
  ansible.builtin.import_playbook: playbooks/install-podman-driver.yml

- name: Setup Host Volume Directories
  ansible.builtin.import_playbook: playbooks/setup-directories.yml

- name: Deploy CSI Plugins
  ansible.builtin.import_playbook: playbooks/deploy-csi-plugins.yml

- name: Deploy CSI Volumes
  ansible.builtin.import_playbook: playbooks/deploy-csi-volumes.yml
