---
# Deploy media server using Nomad Pack
#
# This playbook deploys either Plex or Jellyfin based on the media_server variable.
#
# Usage:
#   Deploy Plex (default):    ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml
#   Deploy Jellyfin:          ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml -e media_server=jellyfin
#   Without GPU transcoding:  ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml -e media_server_gpu_transcoding=false

- name: Deploy Media Server
  hosts: controller
  gather_facts: true
  become: false
  tasks:
    - name: Validate media_server value
      ansible.builtin.assert:
        that:
          - media_server in ['plex', 'jellyfin']
        fail_msg: "media_server must be 'plex' or 'jellyfin'. Got: {{ media_server }}"
        success_msg: "Deploying media server: {{ media_server }}"

    # Check prerequisites (skip Podman check on macOS - used as controller only)
    - name: Check if Podman is installed
      ansible.builtin.command:
        cmd: podman --version
      register: podman_check
      changed_when: false
      failed_when: false
      when: ansible_os_family != "Darwin"

    - name: Fail if Podman is not installed
      ansible.builtin.fail:
        msg: "Podman is not installed. Run the full site.yml playbook or install-podman-driver.yml first."
      when: ansible_os_family != "Darwin" and podman_check.rc != 0

    - name: Check if Nomad Pack is installed
      ansible.builtin.command:
        cmd: nomad-pack version
      register: nomad_pack_check
      changed_when: false
      failed_when: false

    - name: Install Nomad Pack if not present
      when: nomad_pack_check.rc != 0
      block:
        # macOS installation via Homebrew
        - name: Tap HashiCorp repository (macOS)
          community.general.homebrew_tap:
            name: hashicorp/tap
            state: present
          when: ansible_os_family == "Darwin"
          become: false

        - name: Install Nomad Pack via Homebrew (macOS)
          community.general.homebrew:
            name: hashicorp/tap/nomad-pack
            state: latest
          when: ansible_os_family == "Darwin"
          become: false

        # Linux installation via direct download
        - name: Get latest Nomad Pack version
          ansible.builtin.uri:
            url: https://api.github.com/repos/hashicorp/nomad-pack/releases/latest
            return_content: true
          register: nomad_pack_release
          when: ansible_os_family != "Darwin"

        - name: Set Nomad Pack version
          ansible.builtin.set_fact:
            nomad_pack_version: "{{ nomad_pack_release.json.tag_name | regex_replace('^v', '') }}"
          when: ansible_os_family != "Darwin"

        - name: Download Nomad Pack
          ansible.builtin.get_url:
            url: "https://releases.hashicorp.com/nomad-pack/{{ nomad_pack_version }}/nomad-pack_{{ nomad_pack_version }}_linux_amd64.zip"
            dest: /tmp/nomad-pack.zip
            mode: '0644'
          when: ansible_os_family != "Darwin"

        - name: Install unzip if not present (Debian/Ubuntu)
          ansible.builtin.apt:
            name: unzip
            state: present
          when: ansible_os_family == "Debian"

        - name: Install unzip if not present (RHEL/CentOS)
          ansible.builtin.dnf:
            name: unzip
            state: present
          when: ansible_os_family == "RedHat"

        - name: Extract Nomad Pack
          ansible.builtin.unarchive:
            src: /tmp/nomad-pack.zip
            dest: /usr/local/bin/
            remote_src: true
            mode: '0755'
          when: ansible_os_family != "Darwin"

        - name: Verify Nomad Pack installation
          ansible.builtin.command:
            cmd: nomad-pack version
          register: nomad_pack_verify
          changed_when: false

        - name: Display Nomad Pack version
          ansible.builtin.debug:
            msg: "Installed Nomad Pack: {{ nomad_pack_verify.stdout }}"

        - name: Clean up download
          ansible.builtin.file:
            path: /tmp/nomad-pack.zip
            state: absent
          when: ansible_os_family != "Darwin"

    # Deploy media server
    - name: Check if Nomad Pack registry exists
      ansible.builtin.command:
        cmd: nomad-pack registry list
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: registry_list
      changed_when: false
      failed_when: false

    - name: Add Nomad Pack registry
      ansible.builtin.command:
        cmd: nomad-pack registry add {{ nomad_pack_registry_name }} {{ nomad_pack_registry_url }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      when: nomad_pack_registry_name not in registry_list.stdout
      register: registry_add
      changed_when: "'added' in registry_add.stdout"

    - name: Build nomad-pack variables
      ansible.builtin.set_fact:
        pack_vars: >-
          -var gpu_transcoding={{ media_server_gpu_transcoding | lower }}
          -var enable_backup={{ media_server_enable_backup | lower }}
          -var enable_update={{ media_server_enable_update | lower }}

    - name: Deploy {{ media_server }} with Nomad Pack
      ansible.builtin.command:
        cmd: nomad-pack run {{ media_server }} --registry={{ nomad_pack_registry_name }} {{ pack_vars }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: pack_result
      changed_when: "'deployed' in pack_result.stdout or 'Plan' in pack_result.stdout"

    - name: Display deployment result
      ansible.builtin.debug:
        var: pack_result.stdout_lines

    - name: Verify job is running
      ansible.builtin.command:
        cmd: nomad job status {{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: job_status
      until: "'running' in job_status.stdout"
      retries: 30
      delay: 5
      changed_when: false

    - name: Display job status
      ansible.builtin.debug:
        msg: "{{ media_server }} is now running. Access at http://192.168.0.10:{{ '32400' if media_server == 'plex' else '8096' }}"
