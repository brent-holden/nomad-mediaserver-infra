---
# Deploy media server using Nomad Pack
#
# This playbook runs on the controller (macOS) and deploys either Plex or Jellyfin
# to the remote Nomad cluster.
#
# Usage:
#   Deploy Plex (default):    ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml
#   Deploy Jellyfin:          ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml -e media_server=jellyfin
#   Without GPU transcoding:  ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml -e media_server_gpu_transcoding=false

- name: Deploy Media Server
  hosts: controller
  gather_facts: true
  tasks:
    - name: Validate media_server value
      ansible.builtin.assert:
        that:
          - media_server in ['plex', 'jellyfin']
        fail_msg: "media_server must be 'plex' or 'jellyfin'. Got: {{ media_server }}"
        success_msg: "Deploying media server: {{ media_server }}"

    # Check and install Nomad Pack via Homebrew
    - name: Check if Nomad Pack is installed
      ansible.builtin.command:
        cmd: nomad-pack version
      register: nomad_pack_check
      changed_when: false
      failed_when: false

    - name: Install Nomad Pack if not present
      when: nomad_pack_check.rc != 0
      block:
        - name: Tap HashiCorp repository
          community.general.homebrew_tap:
            name: hashicorp/tap
            state: present

        - name: Install Nomad Pack via Homebrew
          community.general.homebrew:
            name: hashicorp/tap/nomad-pack
            state: latest

        - name: Verify Nomad Pack installation
          ansible.builtin.command:
            cmd: nomad-pack version
          register: nomad_pack_verify
          changed_when: false

        - name: Display Nomad Pack version
          ansible.builtin.debug:
            msg: "Installed Nomad Pack: {{ nomad_pack_verify.stdout }}"

    # Deploy media server to remote Nomad cluster
    - name: Check if Nomad Pack registry exists
      ansible.builtin.command:
        cmd: nomad-pack registry list
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: registry_list
      changed_when: false
      failed_when: false

    - name: Add Nomad Pack registry
      ansible.builtin.command:
        cmd: nomad-pack registry add {{ nomad_pack_registry_name }} {{ nomad_pack_registry_url }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      when: nomad_pack_registry_name not in registry_list.stdout
      register: registry_add
      changed_when: "'added' in registry_add.stdout"

    - name: Build nomad-pack variables
      ansible.builtin.set_fact:
        pack_vars: >-
          -var gpu_transcoding={{ media_server_gpu_transcoding | lower }}
          -var enable_backup={{ media_server_enable_backup | lower }}
          -var enable_update={{ media_server_enable_update | lower }}

    # Create dynamic host volumes (mkdir plugin creates directories automatically)
    - name: Create Plex config volume
      ansible.builtin.shell: |
        nomad volume create - <<'EOF'
        name      = "plex-config"
        type      = "host"
        plugin_id = "mkdir"
        capability {
          access_mode     = "single-node-writer"
          attachment_mode = "file-system"
        }
        parameters {
          mode = "0755"
          uid  = "{{ user_uid }}"
          gid  = "{{ group_gid }}"
        }
        EOF
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: plex_config_vol
      changed_when: "'Created' in plex_config_vol.stdout"
      failed_when: false
      when: media_server == "plex" or media_server == "both"

    - name: Create Plex transcode volume
      ansible.builtin.shell: |
        nomad volume create - <<'EOF'
        name      = "plex-transcode"
        type      = "host"
        plugin_id = "mkdir"
        capability {
          access_mode     = "single-node-writer"
          attachment_mode = "file-system"
        }
        parameters {
          mode = "0755"
          uid  = "{{ user_uid }}"
          gid  = "{{ group_gid }}"
        }
        EOF
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: plex_transcode_vol
      changed_when: "'Created' in plex_transcode_vol.stdout"
      failed_when: false
      when: media_server == "plex" or media_server == "both"

    - name: Create Jellyfin config volume
      ansible.builtin.shell: |
        nomad volume create - <<'EOF'
        name      = "jellyfin-config"
        type      = "host"
        plugin_id = "mkdir"
        capability {
          access_mode     = "single-node-writer"
          attachment_mode = "file-system"
        }
        parameters {
          mode = "0755"
          uid  = "{{ user_uid }}"
          gid  = "{{ group_gid }}"
        }
        EOF
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: jellyfin_config_vol
      changed_when: "'Created' in jellyfin_config_vol.stdout"
      failed_when: false
      when: media_server == "jellyfin" or media_server == "both"

    - name: Create Jellyfin cache volume
      ansible.builtin.shell: |
        nomad volume create - <<'EOF'
        name      = "jellyfin-cache"
        type      = "host"
        plugin_id = "mkdir"
        capability {
          access_mode     = "single-node-writer"
          attachment_mode = "file-system"
        }
        parameters {
          mode = "0755"
          uid  = "{{ user_uid }}"
          gid  = "{{ group_gid }}"
        }
        EOF
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: jellyfin_cache_vol
      changed_when: "'Created' in jellyfin_cache_vol.stdout"
      failed_when: false
      when: media_server == "jellyfin" or media_server == "both"

    - name: Deploy {{ media_server }} with Nomad Pack
      ansible.builtin.command:
        cmd: nomad-pack run --registry={{ nomad_pack_registry_name }} {{ pack_vars }} {{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: pack_result
      changed_when: "'deployed' in pack_result.stdout or 'Plan' in pack_result.stdout"

    - name: Display deployment result
      ansible.builtin.debug:
        var: pack_result.stdout_lines

    - name: Verify job is running
      ansible.builtin.command:
        cmd: nomad job status {{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: job_status
      until: "'running' in job_status.stdout"
      retries: 30
      delay: 5
      changed_when: false

    - name: Display job status
      ansible.builtin.debug:
        msg: "{{ media_server }} is now running. Access at http://192.168.0.10:{{ '32400' if media_server == 'plex' else '8096' }}"
