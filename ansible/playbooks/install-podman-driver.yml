---
# Playbook to install Podman and the Nomad Podman driver on CentOS Stream 10 or Ubuntu 25.10
- name: Install Podman and Nomad Podman Driver
  hosts: nomad_clients
  become: true

  tasks:
    # CentOS/RHEL tasks
    - name: Install Podman (RHEL)
      ansible.builtin.dnf:
        name:
          - podman
        state: present
      when: ansible_os_family == "RedHat"

    - name: Install nomad-driver-podman (RHEL)
      ansible.builtin.dnf:
        name: nomad-driver-podman
        state: latest
      when: ansible_os_family == "RedHat"

    # Ubuntu/Debian tasks
    - name: Install Podman (Debian)
      ansible.builtin.apt:
        name:
          - podman
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Install nomad-driver-podman (Debian)
      ansible.builtin.apt:
        name: nomad-driver-podman
        state: latest
        update_cache: true
      when: ansible_os_family == "Debian"

    # Common tasks
    - name: Enable and start Podman socket
      ansible.builtin.systemd:
        name: podman.socket
        enabled: true
        state: started

    - name: Create symlink to nomad-driver-podman in plugin directory
      ansible.builtin.file:
        src: /usr/bin/nomad-driver-podman
        dest: "{{ nomad_plugin_dir }}/nomad-driver-podman"
        state: link
        owner: nomad
        group: nomad

    - name: Deploy Podman driver configuration
      ansible.builtin.template:
        src: ../templates/podman.hcl.j2
        dest: "{{ nomad_config_dir }}/podman.hcl"
        owner: root
        group: root
        mode: "0644"
      notify: Restart Nomad

  handlers:
    - name: Restart Nomad
      ansible.builtin.systemd:
        name: nomad
        state: restarted
